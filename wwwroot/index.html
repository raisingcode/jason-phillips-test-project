<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />

    <script>
        //initialize variables and oninit eent
        const apiUrl = "https://localhost:7146";
        const urlParams = new URLSearchParams(window.location.search);
        let folderpath = "";
        const folder = urlParams.get('folder');
        const file_item = urlParams.get('file');
        const file_details = urlParams.get('fileDetails');
        let  download = urlParams.get('download');
        if (folder) {
            // Use folder value, e.g. load its contents
            console.log('Selected folder:', folder);
            folderpath = folder;
            if(file_item && download && download.toLowerCase() === 'true') {
                console.log('Downloading file:', file_item);
                window.open(`${apiUrl}/api/File/download?filepath=${folderpath}&filename=${file_item}`, '_blank');
                  
    
            }
        }
     
        else {
            folderpath = "";
        }
        document.addEventListener("DOMContentLoaded", function () {
            console.log("loaded");

            init_compontents();

        });
        function close_div(elem) {
           const div = document.getElementById(elem);
            div.style.display = "none";
        }
        function action_on_search(name, type, filepath) {
            if(type === "Directory") {
                filepath = filepath + '/' + name;
                window.location.href = `/index.html?folder=${encodeURIComponent(filepath)}`;
            }   
            if(type == "File") {
                const tempurl = new URL(window.location.href);
                tempurl.searchParams.set('folder',filepath);
                tempurl.searchParams.set('fileDetails', name)
                window.location.href = tempurl.toString();
            }
        }
        function search_directory(searchQuery,folderpath=null) {
            document.getElementById("file_search_div").style.display = "block";
            fetch(`${apiUrl}/api/File/searchfiles?searchTerm=${searchQuery}&folderpath=${folderpath}&includeSubfolders=true`)
                .then(res => res.json())
                .then(data => {
                    console.log(data);
                    let html = `<h3>Search Results for ${searchQuery} </h3><table style='border-collapse:collapse;'><tr><th style='text-align:left; padding-right:10px;'>Path</th><th style='text-align:left; padding-right:10px;'>Name</th><th style='text-align:left; padding:18px;'>Type</th><th style='text-align:left; padding:18px;'>Size</th><th>File Count</tr>`;
                    if (!Array.isArray(data.results) || data.results.length === 0) {
                        html += "<tr><td>No files found</td></tr>";
                        document.getElementById("file_search_dialog_content").innerHTML = html;
                    }
                    else {
                        data.results.forEach(file => {

                        html += `<tr style="cursor:pointer; background-color:#f9f9f9;" onmouseover="this.style.backgroundColor='#ffe066'" onmouseout="this.style.backgroundColor='#f9f9f9'" onclick="action_on_search('${file.fileName}', '${file.type}', '${file.filePath}')">
                        <td style="padding-right:10px;">${file.filePath}</td>
                        <td style="padding:18px;">${file.fileName}</td>
                        <td style="padding:18px;">${file.type}</td >
                   
                    </tr>`;
                        })
                    }

                    html += "</table>";
                    document.getElementById("file_search_dialog_content").innerHTML = html;
                })
                .catch(err => {
                    console.error("Error fetching file list:", err);
                    let html = `<div>Error fetching search results</div>`;
                    document.getElementById("file_search_dialog_content").innerHTML = html;
                });
        }


        function init_compontents() {
            const fileUpload = document.getElementById("file_upload_button");

            document.getElementById("file_upload_input").value = "";
            fileUpload.addEventListener("click", uploadFile);

            updateFileList(folderpath)
            registerButtons();
            setInterval(() => updateFileList(folderpath), 5000);
               if(file_details)
                {
                    showFileDetails(folderpath,file_details);
                }

        }

        registerButtons = () => {
            document.getElementById("create_folder_button").onclick = showCreateFolderPrompt;
        }
        function delete_file() {
            console.log(file_details);
            console.log(folderpath);
            fetch(`${apiUrl}/api/File/delete`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Name: file_details, filePath: folderpath })
            })
                .then(function (res) {
                    return res.json().then(function (data) {
                        if (!res.ok) {
                            alert("Failed: " + (data.error || res.statusText));
                        } else {
                            alert("Deleted: " + data.name);
                        }
                    });
                })
                .catch(function (err) {
                    console.error("Request failed", err);
                    alert("Request failed: " + err);
                });
        }

        function action_on_file_directory(name, type, size, fileCount) {

            if (name === "..") {
                const pathParts = folderpath.split('/').filter(part => part); // Split and remove empty parts
                pathParts.pop(); // Remove the last part to go up one level
                const newPath = pathParts.join('/'); // Join back to form the new path
                window.location.href = `/index.html?folder=${encodeURIComponent(newPath)}`;
            }
            else if (type === "Directory") {
                const newPath = folderpath ? `${folderpath}/${name}` : name;
                window.location.href = `/index.html?folder=${encodeURIComponent(newPath)}`;
            }
            else {
            //its a file 
              const fileurl = new URL(window.location.href);
                console.log(fileurl.toString());

                fileurl.searchParams.set('fileDetails',name);
                window.location.href = fileurl.toString();

            }
        }

        function showCreateFolderPrompt() {

            const dialog = document.getElementById("div_create_folder");
            const dialogContent = document.getElementById("dialog_content");
            dialog.innerHTML = `
        <div>
            <label for="folder_name_input">Enter folder name:</label>
            <input id="folder_name_input" type="text" />
            <button id="create_folder_confirm">Create</button>
            <button id="create_folder_cancel">Cancel</button>
        </div>
    `;
            dialog.style.display = "block";

            document.getElementById("create_folder_confirm").onclick = function () {
                const folderName = document.getElementById("folder_name_input").value.trim();
                if (folderName !== "") {
                    fetch(`${apiUrl}/api/File/createfolder`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ "folderName": folderName, "folderPath": folderpath })
                    })
                        .then(res => res.json())
                        .then(data => {
                            alert("Folder created!");
                            console.log(data);
                            updateFileList(folderpath);
                            dialog.style.display = "none";
                        })
                        .catch(err => {
                            alert("Error creating folder");
                            console.error(err);
                        });
                }
            };

            document.getElementById("create_folder_cancel").onclick = function () {
                dialog.style.display = "none";
            };

            document.getElementById("dialog_close").onclick = function () {
                dialog.style.display = "none";
            };
        }


        function updateFileList(folderpath) {
            console.log("updating file list");
            const fileContentDiv = document.getElementById("div_file_content");
            const spanCurrDir = document.getElementById("span_curr_directory");
           folderpath = folderpath.replace(/\\+/g, '/').replace(/\/\//g, ''); // Normalize slashes');
            spanCurrDir.textContent = " /" +( folderpath ? folderpath : "");            fetch(`${apiUrl}/api/File/ListFiles?folderpath=${folderpath}`)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`API error: ${res.status} ${res.statusText}`);
                    }
                    return res.json();
                })
                .then(data => {
                    console.log(data);
                    let html = "<table style='border-collapse:collapse;'><tr><th style='text-align:left; padding-right:10px;'>Name</th><th style='text-align:left; padding:18px;'>Type</th><th style='text-align:left; padding:18px;'>Size</th><th>File Count</tr>";
                    if (!Array.isArray(data) || data.length === 0) {
                        html += `<tr style="cursor:pointer; background-color:#f9f9f9;" onmouseover="this.style.backgroundColor='#ffe066'" onmouseout="this.style.backgroundColor='#f9f9f9'" onclick="action_on_file_directory('..', null, null, null)"><td colspan=4>..</td></tr>`
                        html += "<tr><td>No files found</td></tr>";
                        fileContentDiv.innerHTML = html;
                    }
                    else {
                        html += `<tr style="cursor:pointer; background-color:#f9f9f9;" onmouseover="this.style.backgroundColor='#ffe066'" onmouseout="this.style.backgroundColor='#f9f9f9'"  onclick="action_on_file_directory('..', null, null, null)"><td colspan=4>..</td></tr>`;
                        data.forEach(file => {

                            html += `<tr style="cursor:pointer; background-color:#f9f9f9;" onmouseover="this.style.backgroundColor='#ffe066'" onmouseout="this.style.backgroundColor='#f9f9f9'" onclick="action_on_file_directory('${file.name}', '${file.type}', '${file.size}', '${file.fileCount || ''}')">
                        <td style="padding-right:10px;">${file.name}</td>
                        <td style="padding:18px;">${file.type}</td>
                        <td style="padding:18px;">${(file.size / 1024).toFixed(2)} KB</td>
                        <td style="padding:18px;">${file.fileCount ? file.fileCount : (file.type === "Directory" ? '0' : '')}</td>
                    </tr>`;
                        })
                    }

                    html += "</table>";
                    fileContentDiv.innerHTML = html;
                })
                .catch(err => {
                    console.error("Error fetching file list:", err);
                    let html = `<div>Folder Likely Doesn't Exist </div><div><a href="/index.html">Home</a></div>`;
                    fileContentDiv.innerHTML = html;
                });

        }
        function showFileDetails(folderpath,name) {
            const dialog = document.getElementById("div_more_file_info");
            const dialogContent = document.getElementById("dialog_file_content");
            let htmlvalue = "";
            console.log("showing file details");
            folderpath = !folderpath ? '\\' : folderpath;
            console.log(folderpath);
            fetch(`${apiUrl}/api/File/GetFileInfo?filepath=${folderpath}&filename=${name}`)
                .then(res => res.status != 404 ? res.json(): Promise.reject(new Error("File not found")))
                .then(data => { 
                    console.log(data);

                    htmlvalue = `<div>
                <h3>File Details</h3>
                <p><strong>Name:</strong> ${data.name}</p>
                <p><strong>Type:</strong> ${data.type}</p>
                <p><strong>Size:</strong> ${(data.size / 1024).toFixed(2)} KB</p>
                <button id="close_dialog">Close</button>
                <button id="download_file_button">Download</button>
                <button id="delete_file_button">Delete</button>

                </div>`;
                dialogContent.innerHTML = htmlvalue;
                dialog.style.zIndex = 1000;
                dialog.style.display = "block";

                

            document.getElementById("delete_file_button").onclick = function()
            {
                delete_file();
            }
            

             document.getElementById("close_dialog").onclick = function () {
                const tempurl = new URL(window.location.href);
                tempurl.searchParams.delete('fileDetails');
                dialog.style.display = "none";
                window.location.href = tempurl.toString();
            };
              document.getElementById("download_file_button").onclick = function () {
               
                  dialog.style.display = "none";
                  myurl = new URL(window.location.href);
                  
                  myurl.searchParams.set('download', 'true');
                  myurl.searchParams.set('folder', folderpath);
                  myurl.searchParams.set('file', name);
                  window.location.href = myurl.toString();
                  
            };
                })
                .catch(err => {
                    console.log("caught error");
                  
                    htmlvalue = `<div>Error showing file info ${err}</div>`;
                       dialogContent.innerHTML = htmlvalue;  
                });
            dialogContent.innerHTML = htmlvalue;

            dialog.style.display = "block";


        }
        function uploadFile() {
            console.log("uploading file");
            fileInput = document.getElementById("file_upload_input");
            if (!fileInput.files.length) {
                alert("Pick a file first");
                return;
            }
            const file = fileInput.files[0];
            const maxSize = 20 * 1024 * 1024; // 20MB in bytes
            if (file.size > maxSize) {
                alert("File size exceeds 20MB limit. Please select a smaller file.");
                fileInput.value = ""; // Clear the input
                return;
            }
            const fd = new FormData();
            fd.append("file", file);
            fd.append("folderpath", folderpath);

            try {
                const res = fetch(`${apiUrl}/api/File/upload`,
                    { method: 'POST', body: fd });
                const data = res.then(res => res.status);
                fileInput.value = "";
                data.then(d => console.log(d));
            } catch (ex) {
                console.log(ex);
            }
        }
    </script>
</head>

<body>
    
    <h1>File Manager</h1>
 
    <div style="display: flex; width: 100%;">
      
 
        <div style="flex: .3; min-height: 500px; background: #e1e1e1; padding: 10px; margin: 5px;">
            <h3>Current Directory:<span id="span_curr_directory"></span></h3>
                <div id="div_file_content"> Loading ...</div>
        </div>
        <div style="flex: .6; min-height: 500px; background: #e1e1e1; padding: 10px; margin: 5px;">
           <h3> <span>File Actions</span> </h3>
            <div style="display: flexbox; flex-direction: column; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9;">
                 <h4>Upload Files </h4> <br />
        <div style="display: flexbox; flex-direction: column; gap: 10px; margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; background: #f9f9f9;">

        <div><input id="file_upload_input" type="file" multiple /> <button id="file_upload_button" onclick="uploadFile">Upload</button></div>
 
        </div>
         <div> <h4>Search Files (in Directory)</h4>
                   <div><input id="search_input" placeholder="Search For Files" /><button onclick="search_directory(document.getElementById('search_input').value)">GO</button></div>
        </div>
        <div> <h4>Create Folder</h4>
                   <div><button id="create_folder_button">Create Folder</button></div>
        </div>
    </div>
    <div id="div_create_folder"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; border:1px solid #ccc; box-shadow:0 2px 10px rgba(0,0,0,0.2); padding:20px; z-index:1000; min-width:300px;">
    </div>
    <div>

        </div>
    </div>
    <div id="div_more_file_info"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; border:1px solid #ccc; box-shadow:0 2px 10px rgba(0,0,0,0.2); padding:20px; z-index:1000;">
        <span id="dialog_close"
            style="position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold;" onclick="close_div('div_more_file_info')">&times;</span>
        <div id="dialog_file_content">
            Pleace holder

        </div>
    </div>
        <div id="file_search_div"
        style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:#fff; border:1px solid #ccc; box-shadow:0 2px 10px rgba(0,0,0,0.2); padding:20px; z-index:500;">
        <span id="filse_search_dialog_close"
            style="position:absolute; top:10px; right:15px; cursor:pointer; font-weight:bold;" onclick="close_div('file_search_div')">&times;</span>
        <div id="file_search_dialog_content">
            Place holder

        </div>
    </div>

</html>